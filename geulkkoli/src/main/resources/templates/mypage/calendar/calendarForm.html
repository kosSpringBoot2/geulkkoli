<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>잔디 달력</title>
  <style>
      #calendarBox {
          display: flex;
          flex-direction: column;
          align-items: center;
      }

      .calendar {
          display: flex;
          flex-direction: row;
      }

      .calendar-column {
          display: flex;
          flex-direction: column;
          margin: 10%;
      }

      .calendar-cell {
          flex-basis: 0;
          flex-grow: 1;
          display: flex;
          align-items: center;
          justify-content: center;
          width: 15px;
          height: 15px;
          margin: 2px;
      }

      .borderLine {
          border: gray solid 1px;
      }

      h6 {
          text-align: center;
      }

  </style>

</head>

<body>
<br>
<br>

<div id="calendarBox">
  <h4> < 흔적 남긴 날 > </h4>
  <div class="month"></div>
  <div class="calendar"></div>
</div>


<script>
    const monthNames = [
        "Jan", "Feb", "Mar", "Apr", "May", "Jun",
        "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
    ];

    let calendar = document.getElementsByClassName('calendar').item(0);
    let titleMonth = document.getElementsByClassName('month').item(0);

    async function fetchDataAndProcess() {
        try {
            const response = await fetch(`/myPage/calendar`);
            const data = await response.json();

            calendar.innerHTML = '';
            titleMonth.innerHTML = '';

            let signUpDate = new Date(data.signUpDate);
            let startYear = signUpDate.getFullYear();
            let startMonth = signUpDate.getMonth() + 1;

            let now = new Date();
            let nowYear = now.getFullYear();
            let nowMonth = now.getMonth() + 1;

            let timeDiff = Math.abs(signUpDate.getTime() - now.getTime());
            let diffYears = Math.floor(timeDiff / (1000 * 3600 * 24 * 365));

            //현재 월로부터 직전 1년치 월 단위만 보여주기
            if (diffYears < 1) {
                for (let year = startYear; year <= nowYear; year++) {

                    for (let month = startMonth; month <= 12; month++) {
                        createCalendar(year, month - 1);
                    }

                    for (let month = 1; month <= nowMonth; month++) {
                        createCalendar(year, month - 1);
                    }
                }

            } else {
                if (nowMonth === 12) {
                    for (let month = 1; month <= nowMonth; month++) {
                        createCalendar(nowYear, month - 1);
                    }
                } else {
                    for (let month = nowMonth + 1; month <= 12; month++) {
                        createCalendar(nowYear - 1, month - 1);
                    }
                    for (let month = 1; month <= nowMonth; month++) {
                        createCalendar(nowYear, month - 1);
                    }
                }
            }
        } catch (error) {
            console.error(error);
        }
    }

    // 달의 마지막 날짜(며칠까지 있나)
    function getMonthDates(year, month) {
        return new Date(year, month + 1, 0).getDate();
    }

    // 요일
    function getWeekDay(year, month, date) {
        return new Date(year, month, date).getDay();
    }

    function createCalendar(year, month) {

        let makeH6 = document.createElement('h6');
        let oneMonth = titleMonth.appendChild(makeH6);
        oneMonth.innerText = monthNames[month];

        let firstDay = getWeekDay(year, month, 1);
        let dates = getMonthDates(year, month);
        let columns = Math.ceil((firstDay + dates) / 7);

        let date = 1;
        for (let i = 0; i < columns; i++) {
            let column = document.createElement('div');
            column.classList.add('calendar-row');
            for (let j = 0; j < 7; j++) {
                let cell = document.createElement('div');
                cell.classList.add('calendar-cell');
                if (i === 0 && j < firstDay) {
                    cell.innerHTML = '';
                } else if (date > dates) {
                    cell.innerHTML = '';
                } else {
                    cell.innerHTML = '';
                    cell.classList.add('borderLine');
                    date++;
                }
                column.appendChild(cell);
            }
            calendar.appendChild(column);
        }
    }

    fetchDataAndProcess();

</script>
</body>

<br>
<br>
</html>
