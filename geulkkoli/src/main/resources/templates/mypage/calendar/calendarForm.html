<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>잔디 달력</title>
  <style>
      #calendarBox {
          display: flex;
          flex-direction: column;
          align-items: center;
      }

      .calendar {
          display: inline-grid;
          grid-auto-flow: column;
          flex-direction: row;
      }

      .one-month {
          display: block;
          margin-right: -7.5px;
          margin-left: -7.5px;
      }

      .one-month-columns {
          display: flex;
          flex-direction: row;
      }

      .month-name {
          display: block;
          text-align: center;
          font-size: 15px;
      }

      .days {
          display: flex;
          flex-direction: column;
          margin-top: 20px;
          margin-right: 15px;
          justify-content: space-evenly;
          font-size: 15px;
      }

      .calendar-cell {
          display: flex;
          width: 15px;
          height: 15px;
          border-collapse: collapse;
      }

      .first-column {
          display: flex;
          flex-direction: column;
          margin-top: auto;
          align-items: flex-end;
      }

      .last-column {
          display: flex;
          flex-direction: column;
          margin-bottom: auto;
          align-items: flex-start;
      }

      .borderLine {
          border: gray solid 1px;
      }

      .last-column.seven-cells {
          margin: 0px;
      }

      .coloring {
          background-color: #0a53be;
      }

  </style>

</head>

<body>
<br>
<br>

<div id="calendarBox">
  <h4> < 활동한 날 > </h4>
  <div class="calendar">
    <div class="days"></div>
  </div>
</div>


<script>
    const monthNames = [
        "Jan", "Feb", "Mar", "Apr", "May", "Jun",
        "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
    ];

    const dayNames = ["Mon", "Wed", "Fri"];

    let calendar = document.getElementsByClassName('calendar').item(0);
    let daysBox = document.getElementsByClassName('days').item(0);

    //맨 왼쪽 월수금 출력
    function makeDays() {
        for (let i = 0; i < 3; i++) {
            let createDay = document.createElement('div');
            createDay.innerHTML = dayNames[i];
            daysBox.appendChild(createDay);
        }
    }

    let postingDates; //한 유저의 글 쓴 날들의 집합

    async function settingCalendarDaysByUserSignUpDate() {
        try {
            const response = await fetch(`/myPage/calendar`);
            const data = await response.json();

            makeDays();

            let signUpDate = new Date(data.signUpDate);
            let startYear = signUpDate.getFullYear();
            let startMonth = signUpDate.getMonth() + 1;

            let now = new Date();
            let nowYear = now.getFullYear();
            let nowMonth = now.getMonth() + 1;

            let timeDiff = Math.abs(now.getTime() - signUpDate.getTime());
            let diffYears = Math.floor(timeDiff / (1000 * 3600 * 24 * 365));

            postingDates = data.allPostDatesByOneUser;

            //현재 월로부터 직전 1년치 월 단위만 보여주기
            if (diffYears < 1) { //가입 날짜로부터 현재까지가 1년치 미만일 때 가입 이전 달력 노출되지 않게
                if (startYear === nowYear)
                    for (let month = startMonth; month <= nowMonth; month++) {
                        createCalendar(nowYear, month - 1);
                    } else {
                    for (let year = startYear; year <= nowYear; year++) {
                        for (let month = startMonth; month <= 12; month++) {
                            createCalendar(year, month - 1);
                        }
                        for (let month = 1; month <= nowMonth; month++) {
                            createCalendar(year, month - 1);
                        }
                    }
                }
            } else { //가입 날짜로부터 1년 이상 활동했을 경우
                if (nowMonth === 12) { //현재가 12월이면 다른 년도 갈 필요 없이 해당 년도 1~12월 노출
                    for (let month = 1; month <= nowMonth; month++) {
                        createCalendar(nowYear, month - 1);
                    }
                } else { //현재 기준 과거 달력 1년치만 우선으로 보여주기
                    for (let month = nowMonth + 1; month <= 12; month++) {
                        createCalendar(nowYear - 1, month - 1);
                    }
                    for (let month = 1; month <= nowMonth; month++) {
                        createCalendar(nowYear, month - 1);
                    }
                }
            }
        } catch (error) {
            console.error(error);
        }
    }

    // 달의 마지막 날짜 구하기 (혹은 그 달의 전체 일수로 볼 수도 있는)
    function getMonthDates(year, month) {
        return new Date(year, month + 1, 0).getDate();
    }

    // 요일 구하기
    function getWeekDay(year, month, date) {
        return new Date(year, month, date).getDay();
    }

    function createCalendar(year, month) {

        let oneMonth = document.createElement('div'); //하나의 달 묶음
        oneMonth.classList.add('one-month');
        calendar.appendChild(oneMonth);

        let monthName = document.createElement('div'); //그 달이 무슨 달인지
        oneMonth.appendChild(monthName);
        monthName.innerText = monthNames[month];
        monthName.classList.add('month-name');

        let oneMonthColumns = document.createElement('div');
        oneMonthColumns.classList.add('one-month-columns');
        oneMonth.appendChild(oneMonthColumns);

        let firstDay = getWeekDay(year, month, 1); //요일
        let dates = getMonthDates(year, month); //달의 전체 일수
        let columns = Math.ceil((firstDay + dates) / 7); //주

        let date = 1;
        for (let i = 0; i < columns; i++) {
            let column = document.createElement('div');
            column.classList.add('calendar-column');
            let cellCount = 0; //막주랑 다음 첫주 간격이 벌어지는데 막주에 7일 다 있으면 margin 조절 필요 없어서 조절용 count
            for (let j = 0; j < 7; j++) {
                if (i === 0 && j < firstDay) {
                    column.classList.add('first-column');
                } else if (date > dates) {
                    column.classList.add('last-column');
                } else {
                    let cell = document.createElement('div');
                    cell.classList.add('calendar-cell');
                    cell.innerHTML = '';
                    cell.classList.add('borderLine');
                    column.appendChild(cell);
                    if (checkDate(year, month, date))
                        cell.classList.add('coloring');
                    date++;
                    cellCount++;
                }
            }
            if (cellCount === 7) {
                oneMonth.classList.add('seven-cells');
            }
            oneMonthColumns.appendChild(column);
        }
    }

    settingCalendarDaysByUserSignUpDate();

    //post 연월일과 네모네모로 만들어준 연월일 위치 check (후에 coloring 해주려고)
    function checkDate(year, month, date) {
        for (let oneDate of postingDates) {
            let postingDate = new Date(oneDate);
            let postYear = postingDate.getFullYear();
            let postMonth = postingDate.getMonth();
            let postDate = postingDate.getDate();
            if (postYear === year && postMonth === month && postDate === date) {
                return true;
            }
        }
    }

</script>
</body>

<br>
<br>
</html>
