<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>회원가입</title>
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/userForm.css">

</head>

<body>
<header id="header" th:include="header"></header>
<h1>회원가입</h1>

<br>
<br>

<form action="" th:action th:object="${joinForm}" method="post">
  <div class="mb-3">
    <label for="userName">
      <h4>이름</h4>
    </label>
    <input type="text" name="userName" id="userName"
           th:field="*{userName}"
           th:errorclass="field-error"
           placeholder="홍길동" class="form-control form-control-lg">
    <p class="field-error" th:errors="*{userName}"></p>
  </div>

  <div class="mb-3">
    <label for="nickName">
      <h4>닉네임</h4>
    </label>
    <input type="text" name="nickName" id="nickName" placeholder="2~8자리 / 한글, 영문, 숫자 사용 가능"
           th:field="*{nickName}"
           th:errorclass="field-error"
           class="form-control form-control-lg nickNameInline">
    <p class="field-error" th:errors="*{nickName}"></p>
  </div>

  <div class="mb-3">
    <label for="email">
      <h4>이메일</h4>
    </label>
    <br>
    <div class="email">
      <input type="email" name="email" id="email" placeholder="geulkkoli@welcome.com"
             th:field="*{email}"
             th:errorclass="field-error"
             class="form-control form-control-lg emailBox">
      <input type="button" value="인증" class="btn btn-primary form-control-lg emailButton"
             onclick="checkEmail()">
    </div>
    <p class="field-error" th:errors="*{email}"></p>
    <p id="emailDuplicated"></p>
    <p id="nullOrBlank"></p>

    <div class="email">
      <input type="text" placeholder="이메일로 전송된 인증 번호 6자리 입력" id="authenticationNumber"
             class="form-control form-control-lg authenticationNumberBox" style="display: none">
      <input type="button" value="확인" id="authenticationButton"
             class="btn btn-primary form-control-lg authenticationNumberButton"
             style="display: none"
             onclick="checkAuthenticationNumber()">
    </div>
    <p id="timer"></p>
    <p id="rightOrWrongMessage"></p>
  </div>

  <div class="mb-3">
    <label for="password">
      <h4>비밀번호</h4>
    </label>
    <input type="password" name="password" id="password"
           placeholder="8~20자리 / 영문 소문자, 숫자, 특수문자 포함"
           th:errorclass="field-error"
           class="form-control form-control-lg">
    <p class="field-error" th:errors="*{password}">
    </p>
  </div>

  <div class="mb-3">
    <label for="verify-password">
      <h4>비밀번호 확인</h4>
    </label>
    <input type="password" name="verifyPassword" id="verify-password"
           th:errorclass="field-error"
           placeholder="위 비밀번호와 동일하게 기입"
           class="form-control form-control-lg">
    <p class="field-error" th:errors="*{verifyPassword}"></p>
  </div>

  <div class="mb-3">
    <label for="phoneNo">
      <h4>전화번호</h4>
    </label>
    <input type="tel" name="phoneNo" id="phoneNo"
           th:field="*{phoneNo}"
           th:errorclass="field-error"
           placeholder="숫자만 입력 (01012345678)"
           class="form-control form-control-lg">
    <p class="field-error" th:errors="*{phoneNo}"></p>
  </div>

  <div class="mb-3">
    <h4>성별</h4>
    <div class="form-check form-check-inline">
      <input type="radio" name="gender" id="male" value="male" checked>
      <label for="male">남자</label>
    </div>
    <div class="form-check form-check-inline">
      <input type="radio" name="gender" id="female" value="female">
      <label for="female">여자</label>
    </div>
    <div class="form-check form-check-inline">
      <input type="radio" name="gender" id="non" value="non">
      <label for="non">밝히고 싶지 않음</label>
    </div>
  </div>

  <br>
  <br>

  <div class="mb-3 sub-div">
    <input type="submit" value="가입하기" class="btn btn-primary form-control-lg">
  </div>

</form>
<div id="footer" th:include="footer"></div>
</body>

<script>
    let timer;
    // 이메일 중복 체크 & 인증 번호 수신 가능한 이메일인지 체크
    // 2분 이내에 인증하도록 timer (인증할 동안 이메일 바꾸지 못하도록 input과 button 잠시 비활성화)
    function checkEmail() {
        let email = document.getElementById('email').value;
        document.getElementById('emailDuplicated').innerHTML = "";
        fetch('/checkEmail', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({email: email})
        })
            .then(function (response) {
                if (response.ok) {
                    document.getElementById('emailDuplicated').innerHTML = "";
                    document.getElementById('timer').innerHTML = "";
                    document.getElementById('authenticationNumber').readOnly = false;
                    document.getElementById('authenticationButton').disabled = false;
                    document.getElementById('rightOrWrongMessage').innerHTML = "";
                    return response.text();
                } else {
                    throw new Error('네트워크 문제');
                }
            })
            .then(function (result) {
                if (result === "nullOrBlank") {
                    document.getElementById('nullOrBlank').innerHTML = "공백이거나 입력하지 않은 이메일을 인증할 수 없습니다.";
                }
                if (result === "emailDuplicated") {
                    document.getElementById('timer').innerHTML = "";
                    document.getElementById('emailDuplicated').innerHTML = "이미 존재하는 이메일입니다.";
                }
                if (result === "sendAuthenticationNumberEmail") {
                    document.getElementById('authenticationNumber').style.display = "block";
                    document.getElementById('authenticationButton').style.display = "block";

                    document.getElementById('authenticationNumber').value = "";
                    document.getElementById('authenticationNumber').placeholder = "이메일로 전송된 숫자 6자리 입력";

                    document.getElementById('email').readOnly = true;
                    document.getElementsByClassName('emailButton').item(0).disabled = true;

                    let time = 120;
                    let min, sec;
                    timer = setInterval(function () {
                        // 숫자 두 자리씩 유지
                        min = String(parseInt(time / 60)).padStart(2, '0');
                        sec = String(time % 60).padStart(2, '0');
                        document.getElementById('timer').innerHTML = "발송된 인증 번호를 2분 이내에 입력해주세요. " + min + ":" + sec;
                        time--;

                        if (time < 0) {
                            clearInterval(timer);
                            document.getElementsByClassName('emailButton').item(0).disabled = false;
                            document.getElementById('email').readOnly = false;
                            document.getElementById('timer').innerHTML = "시간이 만료되었습니다. 다시 인증해주세요.";
                        }
                    }, 1000);
                }
            })
            .catch(function (error) {
                alert(error.message);
            });
    }


    function checkAuthenticationNumber() {
        let email = document.getElementById('email').value;
        let authenticationNumber = document.getElementById('authenticationNumber').value;
        fetch('/checkAuthenticationNumber', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({email: email, authenticationNumber: authenticationNumber})
        })
            .then(function (response) {
                if (response.ok) {
                    document.getElementById('rightOrWrongMessage').innerHTML = "";
                    return response.text();
                } else {
                    throw new Error('네트워크 문제');
                }
            })
            .then(function (result) {
                if (result === "wrong") {
                    document.getElementById('rightOrWrongMessage').innerHTML = "인증 번호를 다시 확인해주세요.";
                }
                if (result === "right") {
                    clearInterval(timer);
                    document.getElementById('timer').innerHTML = "";

                    document.getElementById('authenticationNumber').readOnly = true;
                    document.getElementById('authenticationButton').disabled = true;
                    document.getElementById('rightOrWrongMessage').innerHTML = "인증되었습니다.";

                    document.getElementsByClassName('emailButton').item(0).disabled = false;
                    document.getElementById('email').readOnly = false;
                }
            })
            .catch(function (error) {
                alert(error.message);
            });
    }
</script>
</html>